KISSY.add('kg/droplist/2.0.1/index',["dom","event","./droplist"],function(S ,require, exports, module) {KISSY.add(function(t,e,a,r){var n=e("dom"),o=(e("event"),e("./droplist"));o.decorate=function(e,a){var r=[],i=a&&a.attributes||{},l=a.mulSelect?[]:"";t.each(e.options,function(e){var o={text:e.text,value:e.value};t.each(i,function(t,a){o[a]=n.attr(e,t)}),r.push(o),"true"==n.attr(e,"data-default")&&(a.mulSelect?l.push(o):l=o)});var u=t.merge({selectedItem:l,placeholder:n.attr(e,"placeholder"),fieldName:n.attr(e,"name"),mulSelect:n.attr(e,"multiple")?!0:!1,dataSource:r,autoMatch:!0,insertion:function(t){try{n.replaceWith(e,t)}catch(a){n.insertBefore(t,e),n.remove(e)}}},a);return new o(u)},o.multiple=function(e){function a(){this.init()}if(e&&e.dataSource&&e.dataSource.length)return t.augment(a,t.EventTarget,{data:[],arrDoWith:[],init:function(){this.createDropList(e.dataSource)},doWith:function(t,e,a,r){this.data[t]&&this.data[t].doWith(e,a,r),this.arrDoWith[t]=arguments},fireChange:function(t){for(var e=this,a=[],r=0;r<t.length;r++)t[r]._data.selected&&a.push(t[r]._data.selected);e.fire("change",{data:a})},createDropList:function(a){var r=this,n=this.data,i=[];e.subConfig==e.subConfig||[],e.subConfig[n.length]=e.subConfig[n.length]||{};for(var l=t.merge({droplistCls:e.droplistCls,insertion:e.insertion,dataSource:i,freedom:e.freedom,mulSelect:e.mulSelect},e.subConfig[n.length]),u=l.mulSelect?[]:"",c=0;c<a.length;c++){var s={text:a[c][e.paramText],value:a[c][e.paramValue],dataSource:a[c][e.paramSubcat]||[]};i.push(s),!l.selectedItem&&e.isDefault&&a[c][e.isDefault]&&(l.mulSelect?u.push(s):u=s)}l.selectedItem=l.selectedItem||u,droplist=new o(l),n.push(droplist),droplist.deep=n.length,r.arrDoWith[n.length-1]&&droplist.doWith(r.arrDoWith[n.length-1][1],r.arrDoWith[n.length-1][2],r.arrDoWith[n.length-1][3]),droplist.on("change",function(t){function a(){if(e.isShowSub&&e.subcatDeep)for(;e.subcatDeep-n.length;)r.createDropList([])}for(var o=t.currentTarget,i=o._data.selected;n.length>o.deep;)n.pop().destroy();if(!e.subcatDeep||n.length!=e.subcatDeep){if(o.cfg.mulSelect){var l=[];if(i&&i.length)for(var u=0;u<i.length;u++)i[u].dataSource.length&&(l=l.concat(i[u].dataSource));l.length&&r.createDropList(l),(!t.data||l.length)&&a()}else t.data&&t.data.dataSource&&t.data.dataSource.length&&r.createDropList(t.data.dataSource),(!t.data||t.data.dataSource.length)&&a();r.fireChange(n)}}),droplist.render(),e.isShowSub&&e.subcatDeep&&n.length<e.subcatDeep&&r.createDropList([])}}),new a},r.exports=o});});KISSY.add('kg/droplist/2.0.1/droplist',["dom","event","ajax","./datalist","./viewscroll"],function(S ,require, exports, module) {KISSY.add(function(e,t,a,i){function r(){this._init.apply(this,arguments)}var n=t("dom"),l=t("event"),o=t("ajax"),c=t("./datalist"),s=t("./viewscroll"),d="placeholder"in document.createElement("input"),u="",h=function(){},f={hideDelay:100,droplistCls:"",fieldName:"",inputName:"",ariaLabel:"",insertion:document.body,placeholder:"",freedom:!1,customData:void 0,autoMatch:!0,mulSelect:!1,fnDataAdapter:function(e){return e},fnReceive:function(e){return e}},v={wrap:['<div class="droplist {isMultiple} {droplistCls}"><div class="drop-trigger"><i class="caret"></i></div><div class="drop-wrap">',d?void 0:'<label class="drop-placeholder">{placeholder}</label>','<input class="drop-text" type="text" placeholder="{placeholder}" /></div><input class="drop-value" type="hidden" /></div>'].join(u),textCls:"drop-text",valueCls:"drop-value",triggerCls:"drop-trigger",placeholderCls:"drop-placeholder"},p=[9,13,16,17,18,20,27,33,34,35,36,37,38,39,40,45,91,93],g="aria-activedescendant",m={bind:function(e,t){var a=e._view,i=e.elText;n.attr(e.elWrap,{role:"combobox"}),n.attr(i,{role:"textbox"}),n.attr(i,{"aria-autocomplete":"list","aria-haspopup":"true","aria-label":t}),e.on("hide show",function(e){n.attr(i,"aria-expanded","show"===e.type)}),a.on("UIRender",function(){var e=a.elWrap;n.attr(i,{"aria-owns":e[0].id}),a.on("focus",function(t){var i=t.data,r=a.getElement(i);e.attr(g,r?r.id:u)})}),e.on("change",function(){n.attr(a.elWrap,g,u)})}};e.augment(r,e.EventTarget,{_init:function(t){var a=e.merge(f,t);this.cfg=a,a.srcNode&&this._buildWrap(a.srcNode),this._data=new c({selected:a.selectedItem,mulSelect:a.mulSelect}),this._view=new s(this._data,{format:a.format,mulSelect:a.mulSelect}),this._bindControl(),this._timer={hide:null},this._matchMap={}},render:function(){function t(e){var t=a._dataFactory(e);l.setDataSource("",t)}var a=this,i=a.cfg,r=a.elWrap,l=a._data;if(r||(a._buildWrap(),r=a.elWrap,elTrigger=a.elTrigger),!n.parent(r)){var o=i.insertion;e.isFunction(o)?o(r):o.appendChild?o.appendChild(r):e.isString(o)&&(o=n.get(o),o&&o.appendChild&&o.appendChild(r)),i.mulSelect&&elTrigger&&n.remove(elTrigger)}this._bindElement(),m.bind(this,i.ariaLabel);var c=i.dataSource;e.isArray(c)?t(c):e.isString(c)?this._fetch({url:c},function(e){t(e)}):e.isPlainObject(c)?this._fetch(c,function(e){t(e)}):e.isFunction(c)&&c(function(e){t(e)})},doWith:function(e,t,a){var i=this,r=i._grepMethods(e,t,a);i._runWithMatch(r,e,i.getSelectedData())},_grepMethods:function(e,t,a){var i=this,r=i._matchMap[e];r||(r=i._matchMap[e]={match:[],mismatch:[]});var n=i._mergeMethods(r.match,t),l=i._mergeMethods(r.mismatch,a);return{match:n,mismatch:l}},_mergeMethods:function(t,a){var i=[];return e.each(e.makeArray(a),function(a){e.inArray(a,t)||(t.push(a),i.push(a))}),i},removeMatch:function(e){var t=this._matchMap[e];t&&(t.match.length=0,t.mismatch.length=0)},selectByValue:function(e){var t=this._data,a=t.getDataByValue(e);void 0!==e&&!a&&this.cfg.freedom&&(a=this.getCustomData()),t.select(a)},selectByData:function(e){var t=this._data,a=e?t.getDataByValue(e.value):void 0;void 0!==e&&!a&&this.cfg.freedom&&(a=e),t.select(a)},getSelectedData:function(){return this._data.getSelectedData()},getCustomData:function(){var e=this.cfg.customData||{},t={};return t.text=void 0!==e.text?e.text:this.elText.value,t.value=void 0!==e.value?e.value:t.text,t},hide:function(){var e=this._view;e&&e.visible(!1),this.fire("hide")},show:function(){var e=this._view,t=this.elWrap;e.align({node:t,points:["bl","tl"],offset:[0,0]}),e.visible(!0),this.fire("show")},destroy:function(){this.fire("destroy"),n.remove(this.elWrap),this._view.destroy(),this._view=null,this._data=null},_dataFactory:function(e){var t=this.cfg.fnDataAdapter(e);return this._data.dataFactory(t)},_bindControl:function(){var t=this,a=this._view,i=this._data;a.on("UIRender",function(){var e=a.elWrap;n.unselectable(e),l.on(e,"mousedown",function(e){e.preventDefault()})}),a.on("itemSelect",function(e){t._data.select(e.id)}),a.on("focus",function(e){t.cfg.mulSelect?t.elText.value=e.data?e.data.text:"":t._fillText(e.data||t.getSelectedData())}),i.on("selected",function(e){a.select(e.data),t._fillText(e.data),i.saveData(e.data),t.fire("change",{data:e.data,value:t.getValue()}),t.hide()}),t.on("change",function(a){var i=t._matchMap;e.each(i,function(e,i){t._runWithMatch(e,i,a.data)})})},_buildWrap:function(t){var a=this.cfg;if(t=n.get(t),!t){var i=e.substitute(v.wrap,{isMultiple:a.mulSelect?"droplist-multiple":"",droplistCls:a.droplistCls?a.droplistCls:"",placeholder:a.placeholder});t=n.create(i)}var r=n.get("."+v.triggerCls,t),l=n.get("."+v.textCls,t),o=n.get("."+v.valueCls,t),c=n.get("."+v.placeholderCls,t),s=a.fieldName,d=a.inputName||s+"-text";s&&(n.attr(o,"name",s),n.attr(l,"name",d)),this.elPlaceholder=c,this.elWrap=t,this.elValue=o,this.elText=l,this.elTrigger=r},_bindElement:function(){{var t=this,a=(this.cfg,this.elText),i=this.elValue;t._view,t._data}l.on(this.elTrigger,"click",function(){l.fire(a,"focus")}),n.unselectable(this.elTrigger),i&&t.on("change",function(){t.getSelectedData();i.value=t.getValue()});var r=this.elPlaceholder;!d&&l.on(a,"valuechange",function(){var t=n.val(a);""===e.trim(t)?n.show(r):n.hide(r)}),t._bindInput(a)},_bindInput:function(t){var a=this,i=this.elText,r=a.cfg,n=a._data,o=a._view;l.on(t,"click",function(){var e=a._view.getVisible();e||l.fire(i,"focus")}),l.on(t,"focus",function(){var e=a._view.getVisible();a._stopHideTimer(),e?a.hide():(o.render(n.getDataSource()),a.show())}),l.on(t,"blur",function(){var i,n=t.value;r.autoMatch&&(i=a._autoMatchByText(n),i&&a.getSelectedData()&&e.inArray(i,a.getSelectedData())&&(i=void 0)),!r.mulSelect&&void 0===i&&r.freedom&&n!==u&&(i=a.getCustomData()),i?a._data.select(i):(a._fillText(null),a.fire("change",{data:void 0,value:a.getValue()})),a._latencyHide()}),l.on(t,"keydown",function(e){var t=e.keyCode;return 9==t||27==t?void a.hide():38==t||40==t?(e.preventDefault(),a._view.getVisible()?void(40===t?o.focusNext():o.focusPrevious()):(o.render(n.getDataSource()),void a.show())):void(13==t&&(e.preventDefault(),o.selectFocused()))}),l.on(t,"keyup",function(i){function l(t){if(!r.mulSelect){var i=a.getSelectedData();n.selected=void 0,void 0!==i&&a.fire("change",{data:void 0,value:a.getValue()})}if(o.focused=void 0,0===t.length){var l="";e.isFunction(r.emptyFormat)?l=r.emptyFormat(s):e.isString(r.emptyFormat)&&(l=r.emptyFormat),o.emptyRender(l)}else o.render(t);a.show()}var c=i.keyCode;if(!(e.inArray(c,p)||c>=112&&123>=c)){var s=t.value;return s?void(r.remote?a._remoteFilter(s,l):a._syncFilter(s,l)):(o.render(n.getDataSource()),void a.show())}})},_fetch:function(t,a){var i=this,r=e.now();if(i._lastModify=r,!t.url)throw new Error("there is no data");var n=e.merge({type:"GET",dataType:"json",error:function(){alert("请求数据发生错误，请稍后重试。")}},t),l=i.cfg.fnReceive,c=t.success||h;n.success=function(e){if(!(r<i._lastModify)){var t=l(e);t&&(c(t),t.result?a&&a(t.list):alert(t.msg))}},o(n)},_runWithMatch:function(t,a,i){i||(i={}),a==i.value?e.each(t.match,function(e){e&&e({data:i})}):e.each(t.mismatch,function(e){e&&e({data:i})})},_autoMatchByText:function(e){var t=this._data,a=t.getDataByText(e);return a},_fillText:function(e){{var t=this.elText;this.elPlaceholder}this.cfg.mulSelect?(e&&this._addChosen(e),t.value=u):t.value=e?e.text:u},_addChosen:function(t){var a=this.elText,i='<div class="search-choice"><span>{text}</span><a class="search-choice-close" data-id="{__id}"></a></div>',r=e.substitute(i,t);cOption=n.create(r),n.insertBefore(cOption,a),this._bindDelChosen(cOption),this._autoMatchInputWidth()},_bindDelChosen:function(e){var t=this,a=n.get("a",e);l.on(a,"click",function(a){a.preventDefault(),n.remove(e);var i=n.attr(this,"data-id");t._data.delData(i),t._autoMatchInputWidth(),t.fire("change",{data:void 0,value:t.getValue()})})},_autoMatchInputWidth:function(){var e=this.elText,t=n.siblings(e),a=n.width(n.parent(e)),i=0;if(t.length){for(var r=0;r<t.length;r++){var l=n.outerWidth(t[r])+parseInt(n.css(t[r],"marginLeft"))+parseInt(n.css(t[r],"marginRight"));i+=l,i>a&&(i=l)}n.css(e,"width",50>a-i-3?"100%":a-i-3),n.removeAttr(e,"placeholder"),!d&&n.hide(elPlaceholder)}else n.css(e,"width","100%"),n.attr(e,"placeholder",this.cfg.placeholder),!d&&n.show(elPlaceholder)},_remoteFilter:function(t,a){var i=this,r=i.cfg,n=r.remote||{};n.data=e.merge(n.data,{text:t});var l=n;i._fetch(l,function(e){var r=i._dataFactory(e);i._data.setDataSource(t,r),a&&a(r)})},_syncFilter:function(t,a){var i=this,r=i._data,n=[];e.each(r.getDataSource(),function(e){-1!==e.text.indexOf(t)&&n.push(e)}),a&&a(n)},_stopHideTimer:function(){var e=this._timer;e.hide&&(e.hide.cancel(),e.hide=null)},_latencyHide:function(){var t=this,a=t._timer;t._stopHideTimer(),a.hide=e.later(function(){t.hide()},t.cfg.hideDelay)},getValue:function(){var e=this.getSelectedData();if(this.cfg.mulSelect){var t=[];if(e&&e.length)for(var a=0;a<e.length;a++)t.push(e[a].value);return t.join(",")}return e?e.value:""}}),i.exports=r});});