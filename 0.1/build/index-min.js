/*!build time : 2013-10-10 3:56:41 PM*/
KISSY.add("gallery/droplist/0.1/datalist",function(a){function b(){this._init.apply(this,arguments)}var c=(a.DOM,a.Event,"_id"),d="_index",e={dataSource:null};return a.augment(b,a.EventTarget,{_init:function(b){b=this.cfg=a.merge(e,b),this._initSelected=b.selected},dataFactory:function(a){this._dataFactory(a)},getDataByValue:function(b){if(this._list){var c;return a.each(this._list,function(a){return a.value===b?(c=a,!1):void 0}),c}},filter:function(b,c){var d=this,e=[];a.each(d._list,function(c){var d=!1;a.each(b,function(a,b){return a===c[b]?(d=!0,!1):void 0}),d&&e.push(c)}),c&&c(e)},select:function(a){var b;void 0!=a&&(b=this._dataMap[a]);var c=this.selected;c&&b.value===c.value||(this.selected=b,this.fire("selected",{data:b}))},focus:function(a){var b;void 0!=a&&(b=this._dataMap[a]),this.focused=b,this.fire("focus",{data:b})},_getIndex:function(a){var b=this._dataMap[a];return b[d]},nextSibling:function(a){var b=this._getIndex(a);return this._list[b+1]},previousSibling:function(a){var b=this._getIndex(a);return this._list[b-1]},_dataFactory:function(b){var e=this,f=e.selected||e._initSelected,g=[],h=this._dataMap={};e.focused=e.selected=void 0,a.each(b,function(b,i){var j=a.guid();void 0===b[c]&&(b[c]=j),b[d]=i,h[j]=b,g.push(b),f&&b.value==f.value&&(e.select(j),e.focus(j))}),this._list=g}}),b}),KISSY.add("gallery/droplist/0.1/lap",function(a){function b(){var b=a.makeArray(arguments);a.each(b.shift(),function(a){a.apply(null,b)})}function c(b,c){var e=this,f=a.merge(d,c);e.handleData=[].concat(b),e.cfg=f,e.doIndex=-1,e.fnHandlers=[],e.fnBatches=[],e.fnCallbacks=[],e.duration=f.duration||300,e.delay=f.delay||30,e.isPause=!1,e.isStop=!1}var d={duration:300,delay:50},e=[];return a.augment(c,a.EventTarget,{handle:function(a){this.fnHandlers.push(a)},batch:function(a){this.fnBatches.push(a)},then:function(a){this.fnCallbacks.push(a)},start:function(){var a=this;if(a.isStop)throw new Error("the task has complete.");a.isPause=!1,setTimeout(function(){a._process()},0)},process:function(){a.later(this._process,0)},pause:function(){this.isPause=!0},stop:function(){this.isStop||this._stop()},_stop:function(){this.isStop=!0,b(this.fnCallbacks)},_process:function(){var a=this,c=a.handleData,d=a.fnHandlers;if(!(a.isStop||a.isPause&&c.length>0)){var e=+new Date+a.duration,f=-1;do{var g=c.shift();void 0!==g&&(a.doIndex++,f++,b(d,g,a.doIndex,f))}while(c.length>0&&e>+new Date&&!a.isPause&&!a.isStop);b(a.fnBatches,a.doIndex),0!=c.length||a.isStop?setTimeout(function(){a._process()},a.delay):a._stop()}}}),function(a,b){var d=new c(a,b);return e.push(d),d}}),KISSY.add("gallery/droplist/0.1/viewscroll",function(a,b,c,d){function e(){this.init.apply(this,arguments)}var f=a.DOM,g=a.Event,h="",i={selectedCls:"selected",focusCls:"focus",itemCls:"drop-menuitem",prefixId:"dropmenu-item",menuItem:'<li class="drop-menuitem" id="dropmenu-item{{_id}}" data-id="{{_id}}">{{text}}</li>'};return a.augment(e,a.EventTarget,{init:function(a){var c=this,d=new b({prefixCls:"dropmenu-"});c.layer=d,c.elList=f.create("<ul></ul>"),c.datalist=a,d.on("afterRenderUI",function(){c._UIRender()})},render:function(b){if(!b||0==b.length)return!1;var c=this,e=c.lap,g=document.createDocumentFragment();return e&&e.stop(),c.lap?(a.later(function(){c.render(b)},20),!0):(f.html(c.elList,h),e=c.lap=d(b,{duration:30}),e.handle(function(a){var b=c._itemRender(a);b&&g.appendChild(b)}),e.batch(function(){f.append(g,c.elList)}),e.then(function(){f.append(g,c.elList),c.lap=null}),e.start(),!0)},_itemRender:function(a){if(!a)return null;var b=c(i.menuItem).render(a),d=f.create(b),e=this.datalist.selected;return e&&e.value===a.value&&this._selectElement(d),d},_UIRender:function(){var a=this,b=a.layer,c=a.elList,d=b.get("el"),e=b.get("contentEl");e.append(c),a._bindList(),a.elWrap=d,a.fire("UIRender")},_bindList:function(){var a=this,b=a.elList;g.on(b,"click",function(b){var c=b.target;if(f.hasClass(c,i.itemCls)||(c=f.parent(c,i.itemCls)),c){var d=f.attr(c,"data-id");a.fire("itemClick",{id:d})}})},select:function(a){var b=f.get("#"+i.prefixId+a,this.elList);this._selectElement(b)},_selectElement:function(a){f.removeClass(this.selectedItem,i.selectedCls),f.addClass(a,i.selectedCls),this.selectedItem=a},focus:function(a){var b=f.get("#"+i.prefixId+a,this.elList);f.removeClass(this.focusItem,i.focusCls),f.addClass(b,i.focusCls),this.focusItem=b},visible:function(a){a?this.layer.show():this.layer.hide()},align:function(a){this.layer.set("align",a)},scrollIntoView:function(){}}),e},{requires:["overlay","template","./lap"]}),KISSY.add("gallery/droplist/0.1/droplist",function(a,b,c,d,e){function f(){this.init.apply(this,arguments)}var g="",h={hideDelay:100,placeholder:"placeholder",fnAppend:function(a){document.body.appendChild(a)}},i={wrap:'<div class="dropmenu"><div class="drop-trigger"></div><input class="drop-text" type="text" value="{text}" /></div>',textCls:"drop-text",triggerCls:"drop-trigger"},j=[9,13,16,17,18,20,27,33,34,35,36,37,38,39,40,45,91,93];return a.augment(f,a.EventTarget,{init:function(b){var c=a.merge(h,b);c.srcNode&&this._buildWrap(c.srcNode),this.cfg=c,this._data=new d({selected:c.selectedItem}),this._view=new e(this._data),this._bindControl(),this.isVisible=!1,this.timer={search:null,hide:null}},render:function(){this.elWrap||this._buildWrap();var c=this.cfg,d=this._data;if(!b.parent(this.elWrap)){var e=c.fnAppend;a.isFunction(e)&&e(this.elWrap)}this._bindElement(),a.isArray(c.dataSource)?d.dataFactory(c.dataSource):a.isString(c.dataSource)&&this.fetch(c.dataSource,function(a){d.dataFactory(a)})},fetch:function(b,c){var d=this,e=a.now();d._lastModify=e,a.io({url:b,type:"GET",dataType:"json",data:{},success:function(a){return e<d._lastModify?void 0:a.result?(c&&c(a.list),void 0):(alert(a.msg),void 0)}})},_bindElement:function(){var a=this,b=this.elText,d=a._view,e=a._data;a.on("toggle",function(){a._stopHideTimer(),a._keepFocus(),a.isVisible?a.hide():(d.render(e._list),a.show())}),c.on([this.elTrigger,b],"click",function(){a.fire("toggle")}),a._bindInput(b)},_bindControl:function(){var a=this,b=this._view,d=this._data;b.on("UIRender",function(){var d=b.elWrap;c.on(d,"click",function(){a._stopHideTimer(),a._keepFocus()})}),b.on("itemClick",function(b){var c=b.id;a._select(c)}),d.on("selected",function(c){var e=c.data;b.select(e&&e._id),d.focus(e&&e._id),a.fire("change",{data:d.selected})}),d.on("focus",function(c){var e=c.data;b.focus(e&&e._id),e?a._fillText(e):a._fillText(d.selected)})},_keepFocus:function(){c.fire(this.elText,"focus")},_select:function(a){var b=this._data;b.select(a);var c=b.selected;this._fillText(c)},selectByValue:function(a){var b=this.getDataByValue(a);this._select(b._id)},getDataByValue:function(a){return this._data.getDataByValue(a)},_fillText:function(a){var b=this.elText,c=a?a.text:g;b.value=c},hide:function(){this._view.visible(this.isVisible=!1)},show:function(){var a=this._view,b=this.elText;a.align({node:b,points:["bl","tl"],offset:[0,0]}),a.visible(this.isVisible=!0)},_bindInput:function(b){var d=this,e=d._data,f=d._view;c.on(b,"blur",function(){var a=e.selected;d._select(a&&a._id),d._latencyHide()}),c.on(b,"keydown",function(a){var b=a.keyCode;if(9==b||27==b){var c=e.selected;return d._select(c&&c._id),d.hide(),void 0}if(38==b||40==b){if(a.preventDefault(),!d.isVisible)return f.render(e._list),d.show(),void 0;var g,h=e.focused,i=40===b;return g=h?i?e.nextSibling(h._id):e.previousSibling(h._id):e._list[i?0:e._list.length-1],e.focus(g&&g._id),void 0}if(13==b){var j=e.focused;return d._select(j&&j._id),void 0}}),c.on(b,"keyup",function(c){var g=c.keyCode;if(!(a.inArray(g,j)||g>=112&&123>=g)){var h=b.value;return h?(e.filter({text:h},function(a){f.render(a)===!1?d.hide():d.show()}),void 0):(f.render(e._list),d.show(),void 0)}})},_stopHideTimer:function(){var a=this.timer;a.hide&&(a.hide.cancel(),a.hide=null)},_latencyHide:function(){var b=this,c=b.timer;b._stopHideTimer(),c.hide=a.later(function(){b.hide()},b.cfg.hideDelay)},_buildWrap:function(c){if(c=b.get(c),!c){var d=this._data,e=d.selected||d._initSelected,f=a.substitute(i.wrap,{text:e&&e.text});c=b.create(f)}var g=b.get("."+i.triggerCls,c),h=b.get("."+i.textCls,c);this.elWrap=c,this.elText=h,this.elTrigger=g}}),f},{requires:["dom","event","./datalist","./viewscroll"]}),KISSY.add("gallery/droplist/0.1/index",function(a,b,c,d){return d.decorate=function(c){var e,f=[];a.each(c.options,function(a){f.push({text:a.text,value:a.value})});var g=c.options[c.selectedIndex];return e=new d({selectedItem:{value:g.value,text:g.text},dataSource:f,fnAppend:function(a){b.replaceWith(c,a)}})},d},{requires:["dom","event","./droplist"]});